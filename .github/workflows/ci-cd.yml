name: ID CI/CD

on:
  push:
    branches:
      - main
      - master
      - "feat-*"
  pull_request:
    branches:
      - main
      - master

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "22.12.0"
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ${{ github.repository_owner }}/id-service
  FRONTEND_IMAGE: ${{ github.repository_owner }}/id-frontend

jobs:
  backend-sqlite:
    name: Backend (SQLite + coverage gates)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/id
    env:
      DJANGO_SETTINGS_MODULE: app.settings
      PYTHONPATH: src
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: services/id/pyproject.toml

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Dependency audit (Python)
        continue-on-error: true
        run: pip-audit --format=json --output=pip-audit.json

      - name: Ruff check
        run: ruff check src/

      - name: Ruff format check
        run: ruff format --check src/

      - name: Run tests with coverage profile
        env:
          DJANGO_DEBUG: "true"
          DJANGO_SECRET_KEY: "ci-secret-key-min-32-characters-long"
        run: |
          pytest -q --junitxml=pytest-sqlite.xml \
            --cov=accounts.api.exception_handlers \
            --cov=accounts.api.security \
            --cov=accounts.services.rate_limit \
            --cov=core.logging_config \
            --cov=core.middleware \
            --cov=core.security \
            --cov=core.http \
            --cov=core.errors \
            --cov=idp.router \
            --cov=idp.services \
            --cov=updspaceid.providers \
            --cov-branch \
            --cov-report=xml \
            --cov-report=term
          python3 scripts/check_coverage.py \
            --xml coverage.xml \
            --min-line 0.85 \
            --min-branch 0.80 \
            --critical src/accounts/api/security.py \
            --critical src/accounts/services/rate_limit.py \
            --critical src/core/security.py \
            --critical src/core/http.py \
            --critical src/core/errors.py \
            --critical src/idp/router.py \
            --critical-min-line 1.0 \
            --critical-min-branch 1.0

      - name: Upload backend SQLite artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-sqlite-reports
          path: |
            services/id/coverage.xml
            services/id/pytest-sqlite.xml
            services/id/pip-audit.json

  backend-postgres:
    name: Backend (Postgres integration)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: id_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d id_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    defaults:
      run:
        working-directory: services/id
    env:
      DJANGO_SETTINGS_MODULE: app.settings
      PYTHONPATH: src
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: services/id/pyproject.toml

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests on Postgres
        env:
          DJANGO_DEBUG: "true"
          DJANGO_SECRET_KEY: "ci-secret-key-min-32-characters-long"
          DATABASE_URL: "postgresql://postgres:postgres@127.0.0.1:5432/id_test"
        run: pytest -q --junitxml=pytest-postgres.xml

      - name: Upload backend Postgres artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-postgres-reports
          path: services/id/pytest-postgres.xml

  frontend-ci:
    name: Frontend lint/typecheck/unit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web/id-frontend
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: pnpm/action-setup@v4
        with:
          version: 10.3.0
          run_install: false

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Dependency audit (Node)
        continue-on-error: true
        run: pnpm audit --prod --audit-level=high --json > pnpm-audit.json

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

      - name: Unit tests with coverage
        run: pnpm test:coverage

      - name: Upload frontend coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: |
            web/id-frontend/coverage
            web/id-frontend/pnpm-audit.json

  e2e-smoke:
    name: E2E smoke (Playwright)
    runs-on: ubuntu-latest
    needs:
      - frontend-ci
    defaults:
      run:
        working-directory: web/id-frontend
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: pnpm/action-setup@v4
        with:
          version: 10.3.0
          run_install: false

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm e2e:install

      - name: Run smoke E2E
        run: pnpm e2e

      - name: Upload Playwright reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            web/id-frontend/playwright-report
            web/id-frontend/test-results

  compliance-matrix:
    name: Compliance matrix artifact
    runs-on: ubuntu-latest
    if: always()
    needs:
      - backend-sqlite
      - backend-postgres
      - frontend-ci
      - e2e-smoke
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Generate control matrix
        run: |
          python services/id/scripts/generate_compliance_matrix.py \
            --output services/id/docs/compliance/control-matrix.md \
            --backend-status "${{ needs.backend-sqlite.result }}" \
            --postgres-status "${{ needs.backend-postgres.result }}" \
            --frontend-status "${{ needs.frontend-ci.result }}" \
            --e2e-status "${{ needs.e2e-smoke.result }}"

      - name: Upload compliance matrix
        uses: actions/upload-artifact@v4
        with:
          name: compliance-matrix
          path: services/id/docs/compliance/control-matrix.md

  publish-backend:
    name: Publish backend image
    runs-on: ubuntu-latest
    needs:
      - backend-sqlite
      - backend-postgres
      - compliance-matrix
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=sha,format=long
            type=raw,value=latest,enable={{is_default_branch}}

      - uses: docker/build-push-action@v6
        with:
          context: services/id
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  publish-frontend:
    name: Publish frontend image
    runs-on: ubuntu-latest
    needs:
      - frontend-ci
      - e2e-smoke
      - compliance-matrix
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=sha,format=long
            type=raw,value=latest,enable={{is_default_branch}}

      - uses: docker/build-push-action@v6
        with:
          context: web/id-frontend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
